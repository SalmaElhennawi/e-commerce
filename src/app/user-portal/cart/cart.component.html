<div class="cart-container">
  <div class="cart-header">
    <h2>Your Cart</h2>
    <button mat-stroked-button routerLink="/my-orders" class="orders-button">
      <mat-icon>receipt_long</mat-icon>
      My Orders
    </button>
  </div>

  <ng-container *ngIf="(cartItems$ | async) as cartItems">
    <div *ngIf="cartItems.length === 0" class="empty-cart">
      <div class="empty-cart-content">
        <mat-icon class="empty-cart-icon">remove_shopping_cart</mat-icon>
        <h3>Your Shopping Cart is Empty</h3>
        <p>Looks like you haven't added any items to your cart yet</p>
        <button mat-raised-button color="primary" routerLink="/products">
          <mat-icon>shopping_bag</mat-icon>
          Continue Shopping
        </button>
      </div>
    </div>

    <div *ngIf="cartItems.length > 0">
      <table mat-table [dataSource]="cartItems" class="mat-elevation-z8">
        <!-- Index Column -->
        <ng-container matColumnDef="index">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <!-- Image Column -->
        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Image</th>
          <td mat-cell *matCellDef="let item">
            <img [src]="item.product.uploadPhoto" [alt]="item.product.name" class="product-image">
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Product</th>
          <td mat-cell *matCellDef="let item">
            <h3>{{ item.product.name }}</h3>
            <p>Category: {{ item.product.category }}</p>
          </td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price</th>
          <td mat-cell *matCellDef="let item">
            {{ item.product.price | currency }}
          </td>
        </ng-container>

        <!-- Quantity Column -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let item">
            <div class="quantity-control">
              <button mat-icon-button (click)="updateQuantity(item, item.quantity - 1)">
                <mat-icon>remove</mat-icon>
              </button>
              <span>{{ item.quantity }}</span>
              <button mat-icon-button (click)="updateQuantity(item, item.quantity + 1)">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let item">
            {{ item.product.price * item.quantity | currency }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let item">
            <button mat-icon-button color="warn" (click)="removeItem(item.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByCartItemId"></tr>
      </table>

      <div class="order-review">
        <div class="discount-section">
          <div class="discount-code">
            <input type="text" placeholder="Discount code" [(ngModel)]="promoCodeInput">
            <button (click)="applyPromoCode()">Apply</button>
          </div>

          <div *ngIf="appliedPromoCode" class="applied-promo">
            <span>
              Applied: {{appliedPromoCode.code}} ({{appliedPromoCode.discountPercentage}}% off)
              <button mat-icon-button (click)="removePromoCode()">
                <mat-icon>close</mat-icon>
              </button>
            </span>
            <span>-{{discountAmount | currency}}</span>
          </div>
        </div>

        <!-- Use the child component for order summary -->
        <app-order-summary
          [subtotal]="(subtotal$ | async) || 0"
          [shipping]="cartService.shipping"
          [estimatedTax]="cartService.estimatedTax"
          [discountAmount]="discountAmount"
          (checkout)="openCheckout()">
        </app-order-summary>
      </div>
      
      <div class="cart-actions" *ngIf="cartItems.length > 0">
        <button class="clear-cart-button" (click)="clearCart()">Clear Cart</button>
        <button routerLink="/products" class="continue-shopping">Continue Shopping</button>
      </div>
    </div>
  </ng-container>
</div>