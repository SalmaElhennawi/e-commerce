<div class="cart-container">
  <div class="cart-header">
    <h2>Your Cart</h2>
    <button mat-stroked-button routerLink="/my-orders" class="orders-button">
      <mat-icon>receipt_long</mat-icon>
      <span class="orders-button-text">My Orders</span>
    </button>
  </div>

  <ng-container *ngIf="(cartItems$ | async) as cartItems">
    <div *ngIf="cartItems.length === 0" class="empty-cart">
      <div class="empty-cart-content">
        <mat-icon class="empty-cart-icon">remove_shopping_cart</mat-icon>
        <h3>Your Shopping Cart is Empty</h3>
        <p>Looks like you haven't added any items to your cart yet</p>
        <button mat-raised-button color="primary" routerLink="/products" class="continue-shopping-btn">
          <mat-icon>shopping_bag</mat-icon>
          Continue Shopping
        </button>
      </div>
    </div>

    <div *ngIf="cartItems.length > 0" class="cart-content">
      <!-- Mobile Card View -->
      <div class="mobile-cart">
        <div *ngFor="let item of cartItems; let i = index" class="cart-item-card">
          <div class="card-header">
            <span class="item-index">#{{ i + 1 }}</span>
            <button mat-icon-button color="warn" (click)="removeItem(item.id)" class="delete-button" aria-label="Remove item">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          
          <div class="card-content">
            <img [src]="item.product.uploadPhoto" [alt]="item.product.name" class="product-image">
            
            <div class="item-details">
              <h3 class="product-name">{{ item.product.name }}</h3>
              <p class="product-category">Category: {{ item.product.category }}</p>
              <p class="product-price">{{ item.product.price | currency }}</p>
              
              <div class="quantity-control">
                <button mat-icon-button (click)="updateQuantity(item, item.quantity - 1)" aria-label="Decrease quantity">
                  <mat-icon>remove</mat-icon>
                </button>
                <span class="quantity">{{ item.quantity }}</span>
                <button mat-icon-button (click)="updateQuantity(item, item.quantity + 1)" aria-label="Increase quantity">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
              
              <p class="item-total">Total: {{ item.product.price * item.quantity | currency }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop Table View -->
      <div class="table-container">
        <table mat-table [dataSource]="cartItems" class="mat-elevation-z8 desktop-table">
          <!-- Index Column -->
          <ng-container matColumnDef="index">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td>
          </ng-container>

          <!-- Image Column -->
          <ng-container matColumnDef="image">
            <th mat-header-cell *matHeaderCellDef>Image</th>
            <td mat-cell *matCellDef="let item">
              <img [src]="item.product.uploadPhoto" [alt]="item.product.name" class="product-image">
            </td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Product</th>
            <td mat-cell *matCellDef="let item">
              <h3 class="product-name">{{ item.product.name }}</h3>
              <p class="product-category">Category: {{ item.product.category }}</p>
            </td>
          </ng-container>

          <!-- Price Column -->
          <ng-container matColumnDef="price">
            <th mat-header-cell *matHeaderCellDef>Price</th>
            <td mat-cell *matCellDef="let item">
              {{ item.product.price | currency }}
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Quantity</th>
            <td mat-cell *matCellDef="let item">
              <div class="quantity-control">
                <button mat-icon-button (click)="updateQuantity(item, item.quantity - 1)" aria-label="Decrease quantity">
                  <mat-icon>remove</mat-icon>
                </button>
                <span class="quantity">{{ item.quantity }}</span>
                <button mat-icon-button (click)="updateQuantity(item, item.quantity + 1)" aria-label="Increase quantity">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <!-- Total Column -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let item">
              {{ item.product.price * item.quantity | currency }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let item">
              <button mat-icon-button color="warn" (click)="removeItem(item.id)" aria-label="Remove item">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByCartItemId"></tr>
        </table>
      </div>

      <div class="order-review">
        <div class="discount-section">
          <div class="discount-code">
            <input type="text" placeholder="Discount code" [(ngModel)]="promoCodeInput">
            <button (click)="applyPromoCode()">Apply</button>
          </div>

          <div *ngIf="appliedPromoCode" class="applied-promo">
            <span>
              Applied: {{appliedPromoCode.code}} ({{appliedPromoCode.discountPercentage}}% off)
              <button mat-icon-button (click)="removePromoCode()" aria-label="Remove promo code">
                <mat-icon>close</mat-icon>
              </button>
            </span>
            <span>-{{discountAmount | currency}}</span>
          </div>
        </div>

        <!-- Use the child component for order summary -->
        <app-order-summary
          [subtotal]="(subtotal$ | async) || 0"
          [shipping]="cartService.shipping"
          [estimatedTax]="cartService.estimatedTax"
          [discountAmount]="discountAmount"
          (checkout)="openCheckout()">
        </app-order-summary>
      </div>
      
      <div class="cart-actions" *ngIf="cartItems.length > 0">
        <button class="clear-cart-button" (click)="clearCart()">Clear Cart</button>
        <button routerLink="/products" class="continue-shopping">Continue Shopping</button>
      </div>
    </div>
  </ng-container>
</div>